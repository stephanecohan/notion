<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timer circulaire</title>
    <style>
      :root {
        --bg: #0d0d15;
        --panel: #1f1f2b;
        --accent: #ac19bd;
        --muted: #777;
        --text: #f5f5fa;
        --rainbow-duration: 10s;
        --ring-size: 360px;
      }
      * {
        box-sizing: border-box;
      }
      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont,
          sans-serif;
        background: radial-gradient(circle at top, #1e1b3a, #0b0b12 70%);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
      }
      .app-shell {
        width: min(440px, 100%);
        background: var(--panel);
        border-radius: 28px;
        padding: 28px 24px 36px;
        box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
        display: flex;
        flex-direction: column;
        gap: 24px;
      }
      .timer-wrapper {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 18px;
      }
      .timer-shell {
        position: relative;
        width: var(--ring-size);
        height: var(--ring-size);
      }
      .timer-shell .timer-container,
      .timer-overlay {
        position: absolute;
        inset: 0;
      }
      .timer-shell .timer-container {
        width: 100%;
        height: 100%;
        z-index: 1;
      }
      .timer-overlay {
        z-index: 2;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 32px 28px;
        text-align: center;
      }
      .timer-overlay-inner {
        width: 230px;
        max-width: 80%;
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 0 auto;
      }
      .time-adjusters {
        width: 100%;
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 8px;
      }
      .unit {
        background: rgba(255, 255, 255, 0.06);
        border-radius: 14px;
        padding: 8px;
      }
      .unit label {
        display: block;
        font-size: 0.6rem;
        letter-spacing: 0.01em;
        text-transform: uppercase;
        /* color: rgba(255, 255, 255, 0.1); */
        padding-bottom: 8px;
      }
      .time-value {
        display: block;
        font-size: 1.8rem;
        font-weight: 600;
        /* margin: 6px 0; */
        letter-spacing: 0.05em;
      }
      .adjust-btn {
        width: 100%;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.08);
        color: var(--text);
        border-radius: 10px;
        padding: 4px 0;
        font-size: 1.1rem;
        cursor: pointer;
        transition: transform 0.2s ease, border-color 0.2s ease;
      }
      .adjust-btn:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }
      .adjust-btn:not(:disabled):active {
        transform: scale(0.95);
      }
      .progress-ring {
        width: 100%;
        height: 100%;
        transform: rotate(-90deg);
        pointer-events: none;
      }
      .progress-ring__bg {
        fill: none;
        stroke: var(--muted);
        stroke-width: 4;
        opacity: 0.35;
      }
      .progress-ring__circle,
      .progress-ring__bg {
        transform-origin: 50% 50%;
      }
      .progress-ring__circle {
        fill: none;
        stroke: var(--accent);
        stroke-width: 8;
        stroke-linecap: round;
        stroke-dasharray: 816.814;
        stroke-dashoffset: 0;
        transition: stroke-dashoffset 0.25s linear;
        transform-origin: 50% 50%;
      }
      .ring-rainbow {
        stroke: url(#grad1);
        animation: rainbow-rotate var(--rainbow-duration) linear forwards;
      }
      @keyframes rainbow-rotate {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      .readout {
        display: none;
      }
      .timer-container svg {
        width: 100%;
        height: 100%;
        display: block;
      }
      .controls {
        display: flex;
        justify-content: center;
        gap: 16px;
      }
      .icon-btn {
        width: 56px;
        height: 56px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.12);
        color: var(--text);
        display: grid;
        place-items: center;
        cursor: pointer;
        transition: transform 0.2s ease, background 0.2s ease;
      }
      .icon-btn:disabled {
        opacity: 0.35;
        cursor: not-allowed;
      }
      .icon-btn:not(:disabled):active {
        transform: scale(0.9);
      }
      .status {
        text-align: center;
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.65);
        min-height: 18px;
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f3f4f8;
          --panel: #ffffff;
          --text: #111827;
          --muted: #c4c4c4;
        }
        body {
          background: radial-gradient(circle at top, #ffffff, #e5e7eb 70%);
        }
        .app-shell {
          box-shadow: 0 20px 60px rgba(15, 23, 42, 0.18);
        }
        .unit {
          background: rgba(15, 23, 42, 0.03);
        }
        .adjust-btn {
          background: rgba(15, 23, 42, 0.04);
          border-color: rgba(15, 23, 42, 0.08);
        }
        .icon-btn {
          background: rgba(15, 23, 42, 0.04);
          border-color: rgba(15, 23, 42, 0.08);
        }
        .status {
          color: rgba(15, 23, 42, 0.7);
        }
      }
    </style>
  </head>
  <body>
    <div class="app-shell">
      <div class="timer-wrapper">
        <div class="timer-shell">
          <div class="timer-container">
            <svg class="progress-ring" viewBox="0 0 300 300">
              <defs>
                <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#ff0000"></stop>
                  <stop offset="16%" stop-color="#ff7f00"></stop>
                  <stop offset="33%" stop-color="#ffff00"></stop>
                  <stop offset="50%" stop-color="#00ff00"></stop>
                  <stop offset="66%" stop-color="#0000ff"></stop>
                  <stop offset="83%" stop-color="#8b00ff"></stop>
                  <stop offset="100%" stop-color="#ff0000"></stop>
                </linearGradient>
              </defs>
              <circle class="progress-ring__bg" cx="150" cy="150" r="130"></circle>
              <circle
                class="progress-ring__circle"
                id="ring"
                cx="150"
                cy="150"
                r="130"
              ></circle>
            </svg>
          </div>
          <div class="timer-overlay">
            <div class="timer-overlay-inner">
              <div class="readout" id="readout">00:00:00</div>
              <div class="time-adjusters" id="timeAdjusters">
                <div class="unit" data-unit="hours">
                  <button class="adjust-btn" data-unit="hours" data-direction="inc">
                    +
                  </button>
                  <span class="time-value" data-unit="hours">00</span>
                  <label>Heures</label>
                  <button class="adjust-btn" data-unit="hours" data-direction="dec">
                    -
                  </button>
                </div>
                <div class="unit" data-unit="minutes">
                  <button
                    class="adjust-btn"
                    data-unit="minutes"
                    data-direction="inc"
                  >
                    +
                  </button>
                  <span class="time-value" data-unit="minutes">00</span>
                  <label>Minutes</label>
                  <button
                    class="adjust-btn"
                    data-unit="minutes"
                    data-direction="dec"
                  >
                    -
                  </button>
                </div>
                <div class="unit" data-unit="seconds">
                  <button
                    class="adjust-btn"
                    data-unit="seconds"
                    data-direction="inc"
                  >
                    +
                  </button>
                  <span class="time-value" data-unit="seconds">00</span>
                  <label>Secondes</label>
                  <button
                    class="adjust-btn"
                    data-unit="seconds"
                    data-direction="dec"
                  >
                    -
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="controls">
        <button class="icon-btn" id="startBtn" title="Démarrer">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polygon points="5 3 19 12 5 21 5 3"></polygon>
          </svg>
        </button>
        <button class="icon-btn" id="pauseBtn" title="Pause" disabled="">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <rect x="6" y="4" width="4" height="16"></rect>
            <rect x="14" y="4" width="4" height="16"></rect>
          </svg>
        </button>
        <button class="icon-btn" id="resetBtn" title="Réinitialiser">
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <polyline points="23 4 23 10 17 10"></polyline>
            <polyline points="1 20 1 14 7 14"></polyline>
            <path
              d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"
            ></path>
          </svg>
        </button>
      </div>
      <div class="status" id="statusMsg"></div>
    </div>
    <script>
      const STORAGE_END = "circularTimerEndTime";
      const STORAGE_DURATION = "circularTimerDuration";
      const CIRCUMFERENCE = 816.814;
      const ring = document.getElementById("ring");
      const readout = document.getElementById("readout");
      const statusMsg = document.getElementById("statusMsg");
      const startBtn = document.getElementById("startBtn");
      const pauseBtn = document.getElementById("pauseBtn");
      const resetBtn = document.getElementById("resetBtn");
      const adjustButtons = document.querySelectorAll(".adjust-btn");
      const timeSpans = {
        hours: document.querySelector('.time-value[data-unit="hours"]'),
        minutes: document.querySelector('.time-value[data-unit="minutes"]'),
        seconds: document.querySelector('.time-value[data-unit="seconds"]'),
      };

      const state = { hours: 0, minutes: 0, seconds: 0 };
      let countdownInterval = null;
      let endTime = null;
      let totalDuration = 0;
      let rainbowTimeout = null;

      ring.style.strokeDasharray = CIRCUMFERENCE;
      ring.style.strokeDashoffset = 0;

      adjustButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          if (countdownInterval) return;
          const unit = btn.dataset.unit;
          const dir = btn.dataset.direction === "inc" ? 1 : -1;
          adjustUnit(unit, dir);
        });
      });

      startBtn.addEventListener("click", startTimer);
      pauseBtn.addEventListener("click", pauseTimer);
      resetBtn.addEventListener("click", resetTimer);

      window.addEventListener("load", restoreTimerFromStorage);

      function adjustUnit(unit, step) {
        const max = unit === "hours" ? 23 : 59;
        const min = 0;
        let value = state[unit] + step;
        if (value > max) value = min;
        if (value < min) value = max;
        state[unit] = value;
        updateDisplayFromState();
        statusMsg.textContent = "";
      }

      function updateDisplayFromState() {
        Object.entries(state).forEach(([unit, val]) => {
          timeSpans[unit].textContent = String(val).padStart(2, "0");
        });
        readout.textContent = `${format(state.hours)}:${format(
          state.minutes
        )}:${format(state.seconds)}`;
      }

      function format(value) {
        return String(Math.max(0, value)).padStart(2, "0");
      }

      function getTotalMillisFromState() {
        return (
          (state.hours * 3600 + state.minutes * 60 + state.seconds) * 1000
        );
      }

      function startTimer() {
        if (countdownInterval) return;
        const totalMs = getTotalMillisFromState();
        if (totalMs <= 0) {
          statusMsg.textContent = "Définissez un temps avant de démarrer.";
          return;
        }
        totalDuration = totalMs;
        endTime = Date.now() + totalMs;
        localStorage.setItem(STORAGE_END, String(endTime));
        localStorage.setItem(STORAGE_DURATION, String(totalDuration));
        resumeCountdown();
        statusMsg.textContent = "Minuteur en cours...";
      }

      function resumeCountdown() {
        toggleAdjusters(true);
        pauseBtn.disabled = false;
        startBtn.disabled = true;
        ring.classList.remove("ring-rainbow");
        clearInterval(countdownInterval);
        countdownInterval = setInterval(tick, 200);
        tick();
      }

      function tick() {
        if (!endTime || !totalDuration) return;
        const remaining = Math.max(0, endTime - Date.now());
        if (remaining <= 0) {
          handleCompletion();
          return;
        }
        setStateFromMillis(remaining);
        updateRing(remaining);
      }

      function pauseTimer() {
        if (!countdownInterval) return;
        clearInterval(countdownInterval);
        countdownInterval = null;
        const remaining = Math.max(0, endTime - Date.now());
        if (remaining > 0) {
          setStateFromMillis(remaining);
          updateRing(remaining);
        }
        endTime = null;
        localStorage.removeItem(STORAGE_END);
        localStorage.removeItem(STORAGE_DURATION);
        pauseBtn.disabled = true;
        startBtn.disabled = false;
        toggleAdjusters(false);
        statusMsg.textContent = "Pause";
      }

      function resetTimer() {
        clearInterval(countdownInterval);
        countdownInterval = null;
        clearTimeout(rainbowTimeout);
        ring.classList.remove("ring-rainbow");
        endTime = null;
        totalDuration = 0;
        state.hours = state.minutes = state.seconds = 0;
        updateDisplayFromState();
        updateRing(0);
        pauseBtn.disabled = true;
        startBtn.disabled = false;
        toggleAdjusters(false);
        localStorage.removeItem(STORAGE_END);
        localStorage.removeItem(STORAGE_DURATION);
        statusMsg.textContent = "Minuteur réinitialisé.";
      }

      function handleCompletion() {
        clearInterval(countdownInterval);
        countdownInterval = null;
        localStorage.removeItem(STORAGE_END);
        localStorage.removeItem(STORAGE_DURATION);
        setStateFromMillis(0);
        totalDuration = 0;
        showCelebrationRing();
        toggleAdjusters(false);
        pauseBtn.disabled = true;
        startBtn.disabled = true;
        statusMsg.textContent = "Terminé !";
        triggerRainbow();
        playBell();
        rainbowTimeout = setTimeout(() => {
          ring.classList.remove("ring-rainbow");
          startBtn.disabled = false;
          resetTimer();
        }, parseDurationVar());
      }

      function parseDurationVar() {
        const style = getComputedStyle(document.documentElement);
        const value = style.getPropertyValue("--rainbow-duration").trim();
        if (value.endsWith("ms")) return parseFloat(value);
        if (value.endsWith("s")) return parseFloat(value) * 1000;
        return 5000;
      }

      function setStateFromMillis(ms) {
        const totalSeconds = Math.floor(ms / 1000);
        state.hours = Math.floor(totalSeconds / 3600);
        state.minutes = Math.floor((totalSeconds % 3600) / 60);
        state.seconds = totalSeconds % 60;
        updateDisplayFromState();
      }

      function updateRing(remaining, completed = false) {
        if (!totalDuration) {
          ring.style.strokeDashoffset = 0;
          return;
        }
        const progress = completed ? 1 : 1 - remaining / totalDuration;
        ring.style.strokeDashoffset = Math.min(
          CIRCUMFERENCE,
          Math.max(0, progress * CIRCUMFERENCE)
        );
      }

      function toggleAdjusters(disabled) {
        adjustButtons.forEach((btn) => (btn.disabled = disabled));
      }

      function restoreTimerFromStorage() {
        const storedEnd = Number(localStorage.getItem(STORAGE_END));
        const storedDuration = Number(localStorage.getItem(STORAGE_DURATION));
        if (storedEnd && storedDuration) {
          const remaining = storedEnd - Date.now();
          if (remaining > 0) {
            totalDuration = storedDuration;
            endTime = storedEnd;
            resumeCountdown();
            return;
          }
          localStorage.removeItem(STORAGE_END);
          localStorage.removeItem(STORAGE_DURATION);
        }
        updateDisplayFromState();
      }

      function triggerRainbow() {
        ring.classList.add("ring-rainbow");
      }

      function showCelebrationRing() {
        const previousTransition = ring.style.transition;
        ring.style.transition = "none";
        ring.style.strokeDashoffset = 0;
        ring.getBoundingClientRect();
        ring.style.transition = previousTransition || "stroke-dashoffset 0.25s linear";
      }

      // 7. SONNETTE JOUET - Fun et léger
      function playBell() {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const dur = 2;
        function tone(f, delay = 0, vol = 0.25) {
          const o = ctx.createOscillator(),
            g = ctx.createGain();
          o.type = "triangle";
          o.frequency.value = f;
          o.connect(g);
          g.connect(ctx.destination);
          const t = ctx.currentTime + delay;
          g.gain.setValueAtTime(vol, t);
          g.gain.exponentialRampToValueAtTime(0.001, t + dur);
          o.start(t);
          o.stop(t + dur);
        }
        tone(1047, 0);
        tone(1319, 0.15);
        tone(1568, 0.3);
        tone(2093, 0.45);
        tone(1568, 0.7);
        tone(1319, 0.85);
        tone(1047, 1.0);
      }

      updateDisplayFromState();
    </script>
  </body>
</html>

